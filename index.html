<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bulle Klick!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #FFF8EE;
    --caramel: #C8813A;
    --dark-brown: #3D1A00;
    --golden: #F5C842;
    --red: #E8445A;
    --green: #3BC47A;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    font-family: 'Nunito', sans-serif;
    overflow: hidden;
    user-select: none;
  }

  /* Bakgrundsrullande dekor */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(circle at 20% 20%, #FDEFD0 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, #FFE4B5 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  #game-wrap {
    position: relative;
    width: 100vw;
    height: 100vh;
    z-index: 1;
  }

  /* HUD */
  #hud {
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 28px;
    background: var(--dark-brown);
    color: var(--cream);
    font-family: 'Fredoka One', cursive;
    font-size: 1.3rem;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(61,26,0,0.3);
  }

  .hud-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .hud-label {
    font-size: 0.75rem;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    opacity: 0.6;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: block;
    line-height: 1;
  }

  .hud-val {
    font-size: 1.6rem;
    line-height: 1;
    color: var(--golden);
  }

  #timer-val {
    color: var(--golden);
    transition: color 0.3s;
  }
  #timer-val.danger { color: var(--red); animation: pulse 0.5s infinite alternate; }

  @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.15); } }

  /* Po√§ngpip-animation */
  .pip {
    position: fixed;
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    pointer-events: none;
    z-index: 200;
    animation: pip-up 0.8s ease-out forwards;
  }
  .pip.plus { color: var(--green); }
  .pip.minus { color: var(--red); }

  @keyframes pip-up {
    0%   { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-70px) scale(1.4); }
  }

  /* Bulle */
  .bulle {
    position: absolute;
    cursor: pointer;
    transform-origin: center;
    animation: bulle-in 0.25s cubic-bezier(0.34,1.56,0.64,1) forwards;
    z-index: 10;
  }

  @keyframes bulle-in {
    from { transform: scale(0) rotate(-20deg); opacity: 0; }
    to   { transform: scale(1) rotate(0deg);  opacity: 1; }
  }

  .bulle:hover { transform: scale(1.12); }

  .bulle-svg { filter: drop-shadow(0 4px 8px rgba(61,26,0,0.3)); }

  /* Explode-animation */
  .bulle.explode {
    animation: bulle-explode 0.3s ease-out forwards;
  }

  @keyframes bulle-explode {
    0%   { transform: scale(1); opacity: 1; }
    50%  { transform: scale(1.4); opacity: 0.8; }
    100% { transform: scale(0); opacity: 0; }
  }

  /* Startsk√§rm */
  #screen-start, #screen-end {
    position: fixed;
    inset: 0;
    background: rgba(61,26,0,0.92);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 300;
    gap: 20px;
    color: var(--cream);
    font-family: 'Fredoka One', cursive;
    text-align: center;
    padding: 20px;
  }

  #screen-start h1, #screen-end h1 {
    font-size: clamp(2.5rem, 8vw, 5rem);
    color: var(--golden);
    text-shadow: 0 4px 0 var(--caramel);
    line-height: 1;
  }

  #screen-start p, #screen-end p {
    font-family: 'Nunito', sans-serif;
    font-size: 1.1rem;
    max-width: 400px;
    opacity: 0.85;
    line-height: 1.6;
  }

  .btn {
    background: var(--golden);
    color: var(--dark-brown);
    border: none;
    font-family: 'Fredoka One', cursive;
    font-size: 1.5rem;
    padding: 14px 48px;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.15s, background 0.15s;
    box-shadow: 0 6px 0 var(--caramel);
    margin-top: 8px;
  }
  .btn:hover { background: #FFD34E; transform: translateY(-2px); }
  .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--caramel); }

  .hs-list {
    font-family: 'Nunito', sans-serif;
    width: 100%;
    max-width: 300px;
  }
  .hs-list h3 {
    font-family: 'Fredoka One', cursive;
    color: var(--golden);
    font-size: 1.2rem;
    margin-bottom: 10px;
    opacity: 0.9;
  }
  .hs-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 14px;
    border-radius: 12px;
    margin-bottom: 6px;
    background: rgba(255,255,255,0.07);
    font-size: 1rem;
    font-weight: 700;
  }
  .hs-row.gold   { background: rgba(245,200,66,0.18); }
  .hs-row.silver { background: rgba(200,200,200,0.13); }
  .hs-row.bronze { background: rgba(176,120,60,0.15); }
  .hs-row.new-entry { animation: flash-new 0.6s ease 3; }
  @keyframes flash-new {
    0%,100% { background: rgba(59,196,122,0.1); }
    50%      { background: rgba(59,196,122,0.4); }
  }
  .hs-medal { font-size: 1.4rem; }
  .hs-score { margin-left: auto; color: var(--golden); font-family: 'Fredoka One', cursive; font-size: 1.2rem; }
  .hs-empty { opacity: 0.4; font-style: italic; font-size: 0.9rem; }

  .big-bulle { font-size: 5rem; animation: float 3s ease-in-out infinite; }
  @keyframes float {
    0%,100% { transform: translateY(0); }
    50%      { transform: translateY(-16px); }
  }

  #result-score {
    font-size: clamp(3rem, 10vw, 6rem);
    color: var(--golden);
    text-shadow: 0 4px 0 var(--caramel);
  }

  #new-highscore {
    display: none;
    font-size: 1.3rem;
    color: var(--green);
    animation: wiggle 0.5s infinite alternate;
  }
  @keyframes wiggle {
    from { transform: rotate(-3deg); }
    to   { transform: rotate(3deg); }
  }
</style>
</head>
<body>

<div id="hud">
  <div class="hud-item">
    <div>
      <span class="hud-label">Po√§ng</span>
      <span class="hud-val" id="score-val">10</span>
    </div>
  </div>
  <div class="hud-item">
    <div style="text-align:center">
      <span class="hud-label">Tid kvar</span>
      <span class="hud-val" id="timer-val">30</span>
    </div>
  </div>
  <div class="hud-item">
    <div style="text-align:right">
      <span class="hud-label">Highscore</span>
      <span class="hud-val" id="hs-val">0</span>
    </div>
  </div>
</div>

<div id="game-wrap" id="arena"></div>

<!-- Start -->
<div id="screen-start">
  <div class="big-bulle">ü•ê</div>
  <h1>Bulle Klick!</h1>
  <p>Klicka p√• bullarna f√∂r <strong>+2 po√§ng</strong>.<br>Undvik broccolin ‚Äî den ger <strong>‚àí5 po√§ng</strong>!<br>Missar du kostar det <strong>‚àí1 po√§ng</strong>.<br>Du b√∂rjar med <strong>10 po√§ng</strong> och har 30 sekunder!</p>
  <div class="hs-list">
    <h3>üèÜ Topp 3 ‚Äì Globalt</h3>
    <div id="hs-list-start"></div>
  </div>
  <button class="btn" onclick="startGame()">Spela!</button>
</div>

<!-- Game over -->
<div id="screen-end" style="display:none">
  <div class="big-bulle">ü•ê</div>
  <h1>Tid √§r ute!</h1>
  <div id="result-score">0p</div>
  <div id="new-highscore">üèÜ Nytt highscore!</div>
  <div id="name-wrap" style="display:none;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:300px;">
    <input id="player-name" type="text" maxlength="20" placeholder="Ditt namn..." style="
      font-family:'Nunito',sans-serif;font-size:1.1rem;font-weight:700;
      padding:10px 18px;border-radius:50px;border:3px solid var(--golden);
      background:rgba(255,255,255,0.1);color:var(--cream);
      width:100%;text-align:center;outline:none;
    "/>
    <button id="submit-score-btn" class="btn" style="margin-top:0;font-size:1.1rem;padding:10px 32px;">Spara po√§ng!</button>
  </div>
  <div class="hs-list">
    <h3>üèÜ Topp 3 ‚Äì Globalt</h3>
    <div id="hs-list-end"></div>
  </div>
  <button class="btn" onclick="startGame()">Spela igen!</button>
</div>

<script>
const SUPABASE_URL = 'https://zgchlrbochtphxaqtclj.supabase.co';
const SUPABASE_KEY = 'sb_publishable_7B6er92vK2YZ0zSg4DFMVw_6BMOdkhS';

let score = 10;
let timeLeft = 30;
let gameRunning = false;
let timerInterval = null;
let bulleTimers = [];

const arena = document.getElementById('game-wrap');
const scoreEl = document.getElementById('score-val');
const timerEl = document.getElementById('timer-val');
const hsEl    = document.getElementById('hs-val');

const medals = ['ü•á','ü•à','ü•â'];
const medalClass = ['gold','silver','bronze'];

// Supabase helpers
async function fetchTopScores() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/highscores?select=name,score&order=score.desc&limit=3`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) return [];
    return await res.json();
  } catch(e) { return []; }
}

async function submitScore(name, score) {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/highscores`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ name, score })
    });
  } catch(e) {}
}

async function renderHSList(containerId, highlightName) {
  const el = document.getElementById(containerId);
  el.innerHTML = '<div class="hs-row"><span class="hs-empty">Laddar...</span></div>';
  const list = await fetchTopScores();
  if (list.length === 0) {
    el.innerHTML = '<div class="hs-row"><span class="hs-empty">Inga po√§ng √§n ‚Äì spela!</span></div>';
    return;
  }
  el.innerHTML = list.map((row, i) => {
    const isNew = highlightName && row.name === highlightName;
    return `<div class="hs-row ${medalClass[i]}${isNew ? ' new-entry' : ''}">
      <span class="hs-medal">${medals[i]}</span>
      <span>${row.name}</span>
      <span class="hs-score">${row.score}p</span>
    </div>`;
  }).join('');
}

async function updateHUD() {
  scoreEl.textContent = score;
  const top = await fetchTopScores();
  hsEl.textContent = top[0]?.score ?? 0;
}

// Emoji bulle
const bulleEmojis = ['üçû', 'ü•ñ', 'ü•ê', 'üßÅ', 'üç©'];
function bulleSVG(size) {
  const emoji = bulleEmojis[Math.floor(Math.random() * bulleEmojis.length)];
  return `<span style="font-size:${size}px;line-height:1;display:block;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.25));user-select:none;">${emoji}</span>`;
}

// Emoji broccoli
function broccoliSVG(size) {
  return `<span style="font-size:${size}px;line-height:1;display:block;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.25));user-select:none;">ü•¶</span>`;
}

function spawnBroccoli() {
  if (!gameRunning) return;
  const size = 45 + Math.random() * 30;
  const el = document.createElement('div');
  el.className = 'bulle broccoli';

  const margin = 80;
  const maxX = window.innerWidth  - size*1.3 - margin;
  const maxY = window.innerHeight - size*1.3 - margin;
  el.style.left = (margin/2 + Math.random() * maxX) + 'px';
  el.style.top  = (margin/2 + Math.random() * maxY) + 'px';
  el.innerHTML = broccoliSVG(size);

  const lifespan = Math.max(1200, 2600 - (30 - timeLeft) * 30);

  el.addEventListener('click', e => {
    e.stopPropagation();
    if (!gameRunning) return;
    score = Math.max(0, score - 5);
    scoreEl.textContent = score;
    showPip(e.clientX, e.clientY, '‚àí5');
    const sv = document.getElementById('score-val');
    sv.style.color = 'var(--red)';
    setTimeout(() => sv.style.color = '', 500);
    removeBulle(el);
  });

  arena.appendChild(el);

  const t = setTimeout(() => { if (el.parentNode) removeBulle(el); }, lifespan);
  bulleTimers.push(t);

  // N√§sta broccoli om ca 5‚Äì9 sek
  const bt = setTimeout(spawnBroccoli, 5000 + Math.random() * 4000);
  bulleTimers.push(bt);
}

function spawnBulle() {
  if (!gameRunning) return;

  const size = 50 + Math.random() * 40; // storlek i px f√∂r emoji-font
  const el = document.createElement('div');
  el.className = 'bulle';

  const margin = 80;
  const maxX = window.innerWidth  - size*1.3 - margin;
  const maxY = window.innerHeight - size*1.3 - margin;
  const x = margin/2 + Math.random() * maxX;
  const y = margin/2 + Math.random() * maxY;

  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.innerHTML = bulleSVG(size);

  // Hur l√§nge bullen stannar (kortare = sv√•rare n√§r tid minskar)
  const lifespan = Math.max(1000, 2200 - (30 - timeLeft) * 30);

  el.addEventListener('click', e => {
    e.stopPropagation();
    if (!gameRunning) return;
    score += 2;
    scoreEl.textContent = score;
    showPip(e.clientX, e.clientY, '+2');
    removeBulle(el);
  });

  arena.appendChild(el);

  // Auto-remove efter lifespan
  const t = setTimeout(() => {
    if (el.parentNode) removeBulle(el, false);
  }, lifespan);
  bulleTimers.push(t);

  // N√§sta bulle
  const spawnDelay = Math.max(400, 1200 - (30 - timeLeft) * 20);
  const st = setTimeout(spawnBulle, spawnDelay);
  bulleTimers.push(st);
}

function removeBulle(el, clicked = true) {
  if (!el.parentNode) return;
  el.classList.add('explode');
  setTimeout(() => el.remove(), 300);
}

function showPip(x, y, text) {
  const pip = document.createElement('div');
  pip.className = 'pip ' + (text.startsWith('+') ? 'plus' : 'minus');
  pip.textContent = text;
  pip.style.left = (x - 20) + 'px';
  pip.style.top  = (y - 20) + 'px';
  document.body.appendChild(pip);
  setTimeout(() => pip.remove(), 800);
}

// Klick p√• bakgrunden = miss
arena.addEventListener('click', e => {
  if (!gameRunning) return;
  if (e.target.closest('.bulle')) return;
  score = Math.max(0, score - 1);
  scoreEl.textContent = score;
  showPip(e.clientX, e.clientY, '‚àí1');
});

function startGame() {
  // Rensa gamla
  document.querySelectorAll('.bulle').forEach(b => b.remove());
  bulleTimers.forEach(clearTimeout);
  bulleTimers = [];
  clearInterval(timerInterval);

  score    = 10;
  timeLeft = 30;
  gameRunning = true;

  timerEl.classList.remove('danger');
  updateHUD();
  timerEl.textContent = timeLeft;

  document.getElementById('screen-start').style.display = 'none';
  document.getElementById('screen-end').style.display   = 'none';

  // Timer
  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = timeLeft;
    if (timeLeft <= 10) timerEl.classList.add('danger');
    if (timeLeft <= 0) endGame();
  }, 1000);

  // Spawna bullar och broccoli
  spawnBulle();
  const bt = setTimeout(spawnBroccoli, 3000 + Math.random() * 3000);
  bulleTimers.push(bt);
}

async function endGame() {
  gameRunning = false;
  clearInterval(timerInterval);
  bulleTimers.forEach(clearTimeout);
  bulleTimers = [];
  document.querySelectorAll('.bulle').forEach(b => b.remove());

  document.getElementById('result-score').textContent = score + 'p';
  document.getElementById('new-highscore').style.display = 'none';
  document.getElementById('screen-end').style.display = 'flex';

  // Fr√•ga efter namn och spara
  const nameInput = document.getElementById('player-name');
  const submitBtn = document.getElementById('submit-score-btn');
  const nameWrap  = document.getElementById('name-wrap');

  nameInput.value = '';
  nameWrap.style.display = 'flex';
  submitBtn.onclick = async () => {
    const name = nameInput.value.trim() || 'Anonym';
    nameWrap.style.display = 'none';
    submitBtn.disabled = true;

    // Kolla om nytt toppscore
    const before = await fetchTopScores();
    const wasTop = before[0]?.score ?? 0;

    await submitScore(name, score);

    if (score > wasTop) {
      document.getElementById('new-highscore').style.display = 'block';
    }
    await renderHSList('hs-list-end', name);
    await updateHUD();
  };

  await renderHSList('hs-list-end');
}

// Init
renderHSList('hs-list-start');
updateHUD();
</script>
</body>
</html>
